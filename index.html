<script>
  // Recupera dados do formulário salvos no localStorage
  window.addEventListener('DOMContentLoaded', () => {
    ['nome', 'email', 'telefone', 'motivo'].forEach(field => {
      const value = localStorage.getItem(field);
      if (value) {
        document.getElementById(field).value = value;
      }
    });

    // Redirecionamento para formulário se necessário (Android + acesso não liberado)
    redirecionarSeNecessario();
  });

  // Função para verificar se o acesso já foi liberado
  function acessoLiberado() {
    return localStorage.getItem('acessoLiberado') === 'true';
  }

  // Marca o acesso como liberado
  function liberarAcesso() {
    localStorage.setItem('acessoLiberado', 'true');
  }

  // URLs permitidas no walled garden (adicione as que usa)
  const walledGarden = [
    'https://acessogv.github.io',
    'https://connectivitycheck.gstatic.com',
    'https://msftconnecttest.com',
    'https://gstatic.com',
    'https://github.io',
    'https://raw.githubusercontent.com'
  ];

  // Função que redireciona para o formulário se o usuário estiver no Android e não liberou acesso
  function redirecionarSeNecessario() {
    if (!navigator.userAgent.includes('Android')) return;
    if (acessoLiberado()) return;

    const urlAtual = window.location.href;

    // Verifica se a urlAtual começa com algum domínio liberado (walled garden)
    const permitido = walledGarden.some(domain => urlAtual.startsWith(domain));
    if (!permitido) {
      // Redireciona para o formulário externo
      window.location.href = 'https://acessogv.github.io/formulario-gasverde/' + window.location.search;
    }
  }

  // Tratamento do envio do formulário
  document.getElementById('visitForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const nome = document.getElementById('nome').value.trim();
    const email = document.getElementById('email').value.trim();
    const telefone = document.getElementById('telefone').value.trim();
    const motivo = document.getElementById('motivo').value.trim();

    if (!nome || !email || !telefone || !motivo) {
      alert('Por favor, preencha todos os campos antes de enviar.');
      return;
    }

    localStorage.setItem('nome', nome);
    localStorage.setItem('email', email);
    localStorage.setItem('telefone', telefone);
    localStorage.setItem('motivo', motivo);

    liberarAcesso();

    const params = window.location.search;
    window.location.href = 'aguarde.html' + params;
  });

  // Função para mostrar notificação web
  function showNotification() {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'granted') {
      new Notification("Formulário Gás Verde", {
        body: "Clique para liberar seu acesso à internet.",
        icon: "https://acessogv.github.io/logogv/favicon.svg"
      });
    } else if (Notification.permission !== 'denied') {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          new Notification("Formulário Gás Verde", {
            body: "Clique para liberar seu acesso à internet.",
            icon: "https://acessogv.github.io/logogv/favicon.svg"
          });
        }
      });
    }
  }

  // Tenta forçar reload da página no Android para abrir no foreground,
  // depois exibe notificação se usuário não interagir
  if (navigator.userAgent.includes('Android')) {
    // Tenta reload após 3s para “despertar” o navegador
    setTimeout(() => {
      if (document.visibilityState === 'hidden' || document.visibilityState === 'prerender') {
        window.location.reload();
      } else {
        // Se já está visível, não precisa reload, mas pode mostrar notificação depois de 7s
        setTimeout(showNotification, 7000);
      }
    }, 3000);

    // Se o usuário mudar o foco da aba, para de tentar reload/notificar
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        // Aqui poderia limpar timers, se quiser
      }
    });
  }
</script>
